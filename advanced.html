

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Extending Twig &mdash; Twig Documentation 1.13.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.13.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Twig Documentation 1.13.0 documentation" href="index.html" />
    <link rel="next" title="Twig Internals" href="internals.html" />
    <link rel="prev" title="Twig for Developers" href="api.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="internals.html" title="Twig Internals"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="api.html" title="Twig for Developers"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Twig Documentation 1.13.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="extending-twig">
<h1>Extending Twig<a class="headerlink" href="#extending-twig" title="Permalink to this headline">¶</a></h1>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">This section describes how to extend Twig as of <strong>Twig 1.12</strong>. If you are
using an older version, read the <a class="reference internal" href="advanced_legacy.html"><em>legacy</em></a> chapter
instead.</p>
</div>
<p>Twig can be extended in many ways; you can add extra tags, filters, tests,
operators, global variables, and functions. You can even extend the parser
itself with node visitors.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The first section of this chapter describes how to extend Twig easily. If
you want to reuse your changes in different projects or if you want to
share them with others, you should then create an extension as described
in the following section.</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">When extending Twig without creating an extension, Twig won&#8217;t be able to
recompile your templates when the PHP code is updated. To see your changes
in real-time, either disable template caching or package your code into an
extension (see the next section of this chapter).</p>
</div>
<p>Before extending Twig, you must understand the differences between all the
different possible extension points and when to use them.</p>
<p>First, remember that Twig has two main language constructs:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">{{</span> <span class="pre">}}</span></tt>: used to print the result of an expression evaluation;</li>
<li><tt class="docutils literal"><span class="pre">{%</span> <span class="pre">%}</span></tt>: used to execute statements.</li>
</ul>
<p>To understand why Twig exposes so many extension points, let&#8217;s see how to
implement a <em>Lorem ipsum</em> generator (it needs to know the number of words to
generate).</p>
<p>You can use a <tt class="docutils literal"><span class="pre">lipsum</span></tt> <em>tag</em>:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">lipsum</span> <span class="m">40</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
<p>That works, but using a tag for <tt class="docutils literal"><span class="pre">lipsum</span></tt> is not a good idea for at least
three main reasons:</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">lipsum</span></tt> is not a language construct;</p>
</li>
<li><p class="first">The tag outputs something;</p>
</li>
<li><p class="first">The tag is not flexible as you cannot use it in an expression:</p>
<div class="highlight-jinja"><pre>{{ 'some text' ~ {% lipsum 40 %} ~ 'some more text' }}</pre>
</div>
</li>
</ul>
<p>In fact, you rarely need to create tags; and that&#8217;s good news because tags are
the most complex extension point of Twig.</p>
<p>Now, let&#8217;s use a <tt class="docutils literal"><span class="pre">lipsum</span></tt> <em>filter</em>:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span class="cp">{{</span> <span class="m">40</span><span class="o">|</span><span class="nf">lipsum</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</div>
<p>Again, it works, but it looks weird. A filter transforms the passed value to
something else but here we use the value to indicate the number of words to
generate (so, <tt class="docutils literal"><span class="pre">40</span></tt> is an argument of the filter, not the value we want to
transform).</p>
<p>Next, let&#8217;s use a <tt class="docutils literal"><span class="pre">lipsum</span></tt> <em>function</em>:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span class="cp">{{</span> <span class="nv">lipsum</span><span class="o">(</span><span class="m">40</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</div>
<p>Here we go. For this specific example, the creation of a function is the
extension point to use. And you can use it anywhere an expression is accepted:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span class="cp">{{</span> <span class="s1">&#39;some text&#39;</span> <span class="o">~</span> <span class="nv">lipsum</span><span class="o">(</span><span class="m">40</span><span class="o">)</span> <span class="o">~</span> <span class="s1">&#39;some more text&#39;</span> <span class="cp">}}</span><span class="x"></span>

<span class="cp">{%</span> <span class="k">set</span> <span class="nv">lipsum</span> <span class="o">=</span> <span class="nv">lipsum</span><span class="o">(</span><span class="m">40</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
<p>Last but not the least, you can also use a <em>global</em> object with a method able
to generate lorem ipsum text:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span class="cp">{{</span> <span class="nv">text.lipsum</span><span class="o">(</span><span class="m">40</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</div>
<p>As a rule of thumb, use functions for frequently used features and global
objects for everything else.</p>
<p>Keep in mind the following when you want to extend Twig:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="37%" />
<col width="14%" />
<col width="35%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">What?</th>
<th class="head">Implementation difficulty?</th>
<th class="head">How often?</th>
<th class="head">When?</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><em>macro</em></td>
<td>trivial</td>
<td>frequent</td>
<td>Content generation</td>
</tr>
<tr class="row-odd"><td><em>global</em></td>
<td>trivial</td>
<td>frequent</td>
<td>Helper object</td>
</tr>
<tr class="row-even"><td><em>function</em></td>
<td>trivial</td>
<td>frequent</td>
<td>Content generation</td>
</tr>
<tr class="row-odd"><td><em>filter</em></td>
<td>trivial</td>
<td>frequent</td>
<td>Value transformation</td>
</tr>
<tr class="row-even"><td><em>tag</em></td>
<td>complex</td>
<td>rare</td>
<td>DSL language construct</td>
</tr>
<tr class="row-odd"><td><em>test</em></td>
<td>trivial</td>
<td>rare</td>
<td>Boolean decision</td>
</tr>
<tr class="row-even"><td><em>operator</em></td>
<td>trivial</td>
<td>rare</td>
<td>Values transformation</td>
</tr>
</tbody>
</table>
<div class="section" id="globals">
<h2>Globals<a class="headerlink" href="#globals" title="Permalink to this headline">¶</a></h2>
<p>A global variable is like any other template variable, except that it&#8217;s
available in all templates and macros:</p>
<div class="highlight-python"><pre>$twig = new Twig_Environment($loader);
$twig-&gt;addGlobal('text', new Text());</pre>
</div>
<p>You can then use the <tt class="docutils literal"><span class="pre">text</span></tt> variable anywhere in a template:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span class="cp">{{</span> <span class="nv">text.lipsum</span><span class="o">(</span><span class="m">40</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="section" id="filters">
<h2>Filters<a class="headerlink" href="#filters" title="Permalink to this headline">¶</a></h2>
<p>Creating a filter is as simple as associating a name with a PHP callable:</p>
<div class="highlight-python"><pre>// an anonymous function
$filter = new Twig_SimpleFilter('rot13', function ($string) {
    return str_rot13($string);
});

// or a simple PHP function
$filter = new Twig_SimpleFilter('rot13', 'str_rot13');

// or a class method
$filter = new Twig_SimpleFilter('rot13', array('SomeClass', 'rot13Filter'));</pre>
</div>
<p>The first argument passed to the <tt class="docutils literal"><span class="pre">Twig_SimpleFilter</span></tt> constructor is the name
of the filter you will use in templates and the second one is the PHP callable
to associate with it.</p>
<p>Then, add the filter to your Twig environment:</p>
<div class="highlight-python"><pre>$twig = new Twig_Environment($loader);
$twig-&gt;addFilter($filter);</pre>
</div>
<p>And here is how to use it in a template:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span class="cp">{{</span> <span class="s1">&#39;Twig&#39;</span><span class="o">|</span><span class="nf">rot13</span> <span class="cp">}}</span><span class="x"></span>

<span class="c">{# will output Gjvt #}</span><span class="x"></span>
</pre></div>
</div>
<p>When called by Twig, the PHP callable receives the left side of the filter
(before the pipe <tt class="docutils literal"><span class="pre">|</span></tt>) as the first argument and the extra arguments passed
to the filter (within parentheses <tt class="docutils literal"><span class="pre">()</span></tt>) as extra arguments.</p>
<p>For instance, the following code:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span class="cp">{{</span> <span class="s1">&#39;TWIG&#39;</span><span class="o">|</span><span class="nf">lower</span> <span class="cp">}}</span><span class="x"></span>
<span class="cp">{{</span> <span class="nv">now</span><span class="o">|</span><span class="nf">date</span><span class="o">(</span><span class="s1">&#39;d/m/Y&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</div>
<p>is compiled to something like the following:</p>
<div class="highlight-python"><pre>&lt;?php echo strtolower('TWIG') ?&gt;
&lt;?php echo twig_date_format_filter($now, 'd/m/Y') ?&gt;</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">Twig_SimpleFilter</span></tt> class takes an array of options as its last
argument:</p>
<div class="highlight-python"><pre>$filter = new Twig_SimpleFilter('rot13', 'str_rot13', $options);</pre>
</div>
<div class="section" id="environment-aware-filters">
<h3>Environment aware Filters<a class="headerlink" href="#environment-aware-filters" title="Permalink to this headline">¶</a></h3>
<p>If you want to access the current environment instance in your filter, set the
<tt class="docutils literal"><span class="pre">needs_environment</span></tt> option to <tt class="docutils literal"><span class="pre">true</span></tt>; Twig will pass the current
environment as the first argument to the filter call:</p>
<div class="highlight-python"><pre>$filter = new Twig_SimpleFilter('rot13', function (Twig_Environment $env, $string) {
    // get the current charset for instance
    $charset = $env-&gt;getCharset();

    return str_rot13($string);
}, array('needs_environment' =&gt; true));</pre>
</div>
</div>
<div class="section" id="context-aware-filters">
<h3>Context aware Filters<a class="headerlink" href="#context-aware-filters" title="Permalink to this headline">¶</a></h3>
<p>If you want to access the current context in your filter, set the
<tt class="docutils literal"><span class="pre">needs_context</span></tt> option to <tt class="docutils literal"><span class="pre">true</span></tt>; Twig will pass the current context as
the first argument to the filter call (or the second one if
<tt class="docutils literal"><span class="pre">needs_environment</span></tt> is also set to <tt class="docutils literal"><span class="pre">true</span></tt>):</p>
<div class="highlight-python"><pre>$filter = new Twig_SimpleFilter('rot13', function ($context, $string) {
    // ...
}, array('needs_context' =&gt; true));

$filter = new Twig_SimpleFilter('rot13', function (Twig_Environment $env, $context, $string) {
    // ...
}, array('needs_context' =&gt; true, 'needs_environment' =&gt; true));</pre>
</div>
</div>
<div class="section" id="automatic-escaping">
<h3>Automatic Escaping<a class="headerlink" href="#automatic-escaping" title="Permalink to this headline">¶</a></h3>
<p>If automatic escaping is enabled, the output of the filter may be escaped
before printing. If your filter acts as an escaper (or explicitly outputs html
or JavaScript code), you will want the raw output to be printed. In such a
case, set the <tt class="docutils literal"><span class="pre">is_safe</span></tt> option:</p>
<div class="highlight-python"><pre>$filter = new Twig_SimpleFilter('nl2br', 'nl2br', array('is_safe' =&gt; array('html')));</pre>
</div>
<p>Some filters may need to work on input that is already escaped or safe, for
example when adding (safe) html tags to originally unsafe output. In such a
case, set the <tt class="docutils literal"><span class="pre">pre_escape</span></tt> option to escape the input data before it is run
through your filter:</p>
<div class="highlight-python"><pre>$filter = new Twig_SimpleFilter('somefilter', 'somefilter', array('pre_escape' =&gt; 'html', 'is_safe' =&gt; array('html')));</pre>
</div>
</div>
<div class="section" id="dynamic-filters">
<h3>Dynamic Filters<a class="headerlink" href="#dynamic-filters" title="Permalink to this headline">¶</a></h3>
<p>A filter name containing the special <tt class="docutils literal"><span class="pre">*</span></tt> character is a dynamic filter as
the <tt class="docutils literal"><span class="pre">*</span></tt> can be any string:</p>
<div class="highlight-python"><pre>$filter = new Twig_SimpleFilter('*_path', function ($name, $arguments) {
    // ...
});</pre>
</div>
<p>The following filters will be matched by the above defined dynamic filter:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">product_path</span></tt></li>
<li><tt class="docutils literal"><span class="pre">category_path</span></tt></li>
</ul>
<p>A dynamic filter can define more than one dynamic parts:</p>
<div class="highlight-python"><pre>$filter = new Twig_SimpleFilter('*_path', function ($name, $suffix, $arguments) {
    // ...
});</pre>
</div>
<p>The filter will receive all dynamic part values before the normal filter
arguments, but after the environment and the context. For instance, a call to
<tt class="docutils literal"><span class="pre">'foo'|a_path_b()</span></tt> will result in the following arguments to be passed to
the filter: <tt class="docutils literal"><span class="pre">('a',</span> <span class="pre">'b',</span> <span class="pre">'foo')</span></tt>.</p>
</div>
</div>
<div class="section" id="functions">
<h2>Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h2>
<p>Functions are defined in the exact same way as filters, but you need to create
an instance of <tt class="docutils literal"><span class="pre">Twig_SimpleFunction</span></tt>:</p>
<div class="highlight-python"><pre>$twig = new Twig_Environment($loader);
$function = new Twig_SimpleFunction('function_name', function () {
    // ...
});
$twig-&gt;addFunction($function);</pre>
</div>
<p>Functions support the same features as filters, except for the <tt class="docutils literal"><span class="pre">pre_escape</span></tt>
and <tt class="docutils literal"><span class="pre">preserves_safety</span></tt> options.</p>
</div>
<div class="section" id="tests">
<h2>Tests<a class="headerlink" href="#tests" title="Permalink to this headline">¶</a></h2>
<p>Tests are defined in the exact same way as filters and functions, but you need
to create an instance of <tt class="docutils literal"><span class="pre">Twig_SimpleTest</span></tt>:</p>
<div class="highlight-python"><pre>$twig = new Twig_Environment($loader);
$test = new Twig_SimpleTest('test_name', function () {
    // ...
});
$twig-&gt;addTest($test);</pre>
</div>
<p>Tests do not support any options.</p>
</div>
<div class="section" id="tags">
<h2>Tags<a class="headerlink" href="#tags" title="Permalink to this headline">¶</a></h2>
<p>One of the most exciting feature of a template engine like Twig is the
possibility to define new language constructs. This is also the most complex
feature as you need to understand how Twig&#8217;s internals work.</p>
<p>Let&#8217;s create a simple <tt class="docutils literal"><span class="pre">set</span></tt> tag that allows the definition of simple
variables from within a template. The tag can be used like follows:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">set</span> <span class="nv">name</span> <span class="o">=</span> <span class="s2">&quot;value&quot;</span> <span class="cp">%}</span><span class="x"></span>

<span class="cp">{{</span> <span class="nv">name</span> <span class="cp">}}</span><span class="x"></span>

<span class="c">{# should output value #}</span><span class="x"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <tt class="docutils literal"><span class="pre">set</span></tt> tag is part of the Core extension and as such is always
available. The built-in version is slightly more powerful and supports
multiple assignments by default (cf. the template designers chapter for
more information).</p>
</div>
<p>Three steps are needed to define a new tag:</p>
<ul class="simple">
<li>Defining a Token Parser class (responsible for parsing the template code);</li>
<li>Defining a Node class (responsible for converting the parsed code to PHP);</li>
<li>Registering the tag.</li>
</ul>
<div class="section" id="registering-a-new-tag">
<h3>Registering a new tag<a class="headerlink" href="#registering-a-new-tag" title="Permalink to this headline">¶</a></h3>
<p>Adding a tag is as simple as calling the <tt class="docutils literal"><span class="pre">addTokenParser</span></tt> method on the
<tt class="docutils literal"><span class="pre">Twig_Environment</span></tt> instance:</p>
<div class="highlight-python"><pre>$twig = new Twig_Environment($loader);
$twig-&gt;addTokenParser(new Project_Set_TokenParser());</pre>
</div>
</div>
<div class="section" id="defining-a-token-parser">
<h3>Defining a Token Parser<a class="headerlink" href="#defining-a-token-parser" title="Permalink to this headline">¶</a></h3>
<p>Now, let&#8217;s see the actual code of this class:</p>
<div class="highlight-python"><pre>class Project_Set_TokenParser extends Twig_TokenParser
{
    public function parse(Twig_Token $token)
    {
        $parser = $this-&gt;parser;
        $stream = $parser-&gt;getStream();

        $name = $stream-&gt;expect(Twig_Token::NAME_TYPE)-&gt;getValue();
        $stream-&gt;expect(Twig_Token::OPERATOR_TYPE, '=');
        $value = $parser-&gt;getExpressionParser()-&gt;parseExpression();
        $stream-&gt;expect(Twig_Token::BLOCK_END_TYPE);

        return new Project_Set_Node($name, $value, $token-&gt;getLine(), $this-&gt;getTag());
    }

    public function getTag()
    {
        return 'set';
    }
}</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">getTag()</span></tt> method must return the tag we want to parse, here <tt class="docutils literal"><span class="pre">set</span></tt>.</p>
<p>The <tt class="docutils literal"><span class="pre">parse()</span></tt> method is invoked whenever the parser encounters a <tt class="docutils literal"><span class="pre">set</span></tt>
tag. It should return a <tt class="docutils literal"><span class="pre">Twig_Node</span></tt> instance that represents the node (the
<tt class="docutils literal"><span class="pre">Project_Set_Node</span></tt> calls creating is explained in the next section).</p>
<p>The parsing process is simplified thanks to a bunch of methods you can call
from the token stream (<tt class="docutils literal"><span class="pre">$this-&gt;parser-&gt;getStream()</span></tt>):</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">getCurrent()</span></tt>: Gets the current token in the stream.</li>
<li><tt class="docutils literal"><span class="pre">next()</span></tt>: Moves to the next token in the stream, <em>but returns the old one</em>.</li>
<li><tt class="docutils literal"><span class="pre">test($type)</span></tt>, <tt class="docutils literal"><span class="pre">test($value)</span></tt> or <tt class="docutils literal"><span class="pre">test($type,</span> <span class="pre">$value)</span></tt>: Determines whether
the current token is of a particular type or value (or both). The value may be an
array of several possible values.</li>
<li><tt class="docutils literal"><span class="pre">expect($type[,</span> <span class="pre">$value[,</span> <span class="pre">$message]])</span></tt>: If the current token isn&#8217;t of the given
type/value a syntax error is thrown. Otherwise, if the type and value are correct,
the token is returned and the stream moves to the next token.</li>
<li><tt class="docutils literal"><span class="pre">look()</span></tt>: Looks a the next token without consuming it.</li>
</ul>
<p>Parsing expressions is done by calling the <tt class="docutils literal"><span class="pre">parseExpression()</span></tt> like we did for
the <tt class="docutils literal"><span class="pre">set</span></tt> tag.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Reading the existing <tt class="docutils literal"><span class="pre">TokenParser</span></tt> classes is the best way to learn all
the nitty-gritty details of the parsing process.</p>
</div>
</div>
<div class="section" id="defining-a-node">
<h3>Defining a Node<a class="headerlink" href="#defining-a-node" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">Project_Set_Node</span></tt> class itself is rather simple:</p>
<div class="highlight-python"><pre>class Project_Set_Node extends Twig_Node
{
    public function __construct($name, Twig_Node_Expression $value, $line, $tag = null)
    {
        parent::__construct(array('value' =&gt; $value), array('name' =&gt; $name), $line, $tag);
    }

    public function compile(Twig_Compiler $compiler)
    {
        $compiler
            -&gt;addDebugInfo($this)
            -&gt;write('$context[\''.$this-&gt;getAttribute('name').'\'] = ')
            -&gt;subcompile($this-&gt;getNode('value'))
            -&gt;raw(";\n")
        ;
    }
}</pre>
</div>
<p>The compiler implements a fluid interface and provides methods that helps the
developer generate beautiful and readable PHP code:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">subcompile()</span></tt>: Compiles a node.</li>
<li><tt class="docutils literal"><span class="pre">raw()</span></tt>: Writes the given string as is.</li>
<li><tt class="docutils literal"><span class="pre">write()</span></tt>: Writes the given string by adding indentation at the beginning
of each line.</li>
<li><tt class="docutils literal"><span class="pre">string()</span></tt>: Writes a quoted string.</li>
<li><tt class="docutils literal"><span class="pre">repr()</span></tt>: Writes a PHP representation of a given value (see
<tt class="docutils literal"><span class="pre">Twig_Node_For</span></tt> for a usage example).</li>
<li><tt class="docutils literal"><span class="pre">addDebugInfo()</span></tt>: Adds the line of the original template file related to
the current node as a comment.</li>
<li><tt class="docutils literal"><span class="pre">indent()</span></tt>: Indents the generated code (see <tt class="docutils literal"><span class="pre">Twig_Node_Block</span></tt> for a
usage example).</li>
<li><tt class="docutils literal"><span class="pre">outdent()</span></tt>: Outdents the generated code (see <tt class="docutils literal"><span class="pre">Twig_Node_Block</span></tt> for a
usage example).</li>
</ul>
</div>
</div>
<div class="section" id="creating-an-extension">
<span id="creating-extensions"></span><h2>Creating an Extension<a class="headerlink" href="#creating-an-extension" title="Permalink to this headline">¶</a></h2>
<p>The main motivation for writing an extension is to move often used code into a
reusable class like adding support for internationalization. An extension can
define tags, filters, tests, operators, global variables, functions, and node
visitors.</p>
<p>Creating an extension also makes for a better separation of code that is
executed at compilation time and code needed at runtime. As such, it makes
your code faster.</p>
<p>Most of the time, it is useful to create a single extension for your project,
to host all the specific tags and filters you want to add to Twig.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">When packaging your code into an extension, Twig is smart enough to
recompile your templates whenever you make a change to it (when
<tt class="docutils literal"><span class="pre">auto_reload</span></tt> is enabled).</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Before writing your own extensions, have a look at the Twig official
extension repository: <a class="reference external" href="http://github.com/fabpot/Twig-extensions">http://github.com/fabpot/Twig-extensions</a>.</p>
</div>
<p>An extension is a class that implements the following interface:</p>
<div class="highlight-python"><pre>interface Twig_ExtensionInterface
{
    /**
     * Initializes the runtime environment.
     *
     * This is where you can load some file that contains filter functions for instance.
     *
     * @param Twig_Environment $environment The current Twig_Environment instance
     */
    function initRuntime(Twig_Environment $environment);

    /**
     * Returns the token parser instances to add to the existing list.
     *
     * @return array An array of Twig_TokenParserInterface or Twig_TokenParserBrokerInterface instances
     */
    function getTokenParsers();

    /**
     * Returns the node visitor instances to add to the existing list.
     *
     * @return array An array of Twig_NodeVisitorInterface instances
     */
    function getNodeVisitors();

    /**
     * Returns a list of filters to add to the existing list.
     *
     * @return array An array of filters
     */
    function getFilters();

    /**
     * Returns a list of tests to add to the existing list.
     *
     * @return array An array of tests
     */
    function getTests();

    /**
     * Returns a list of functions to add to the existing list.
     *
     * @return array An array of functions
     */
    function getFunctions();

    /**
     * Returns a list of operators to add to the existing list.
     *
     * @return array An array of operators
     */
    function getOperators();

    /**
     * Returns a list of global variables to add to the existing list.
     *
     * @return array An array of global variables
     */
    function getGlobals();

    /**
     * Returns the name of the extension.
     *
     * @return string The extension name
     */
    function getName();
}</pre>
</div>
<p>To keep your extension class clean and lean, it can inherit from the built-in
<tt class="docutils literal"><span class="pre">Twig_Extension</span></tt> class instead of implementing the whole interface. That
way, you just need to implement the <tt class="docutils literal"><span class="pre">getName()</span></tt> method as the
<tt class="docutils literal"><span class="pre">Twig_Extension</span></tt> provides empty implementations for all other methods.</p>
<p>The <tt class="docutils literal"><span class="pre">getName()</span></tt> method must return a unique identifier for your extension.</p>
<p>Now, with this information in mind, let&#8217;s create the most basic extension
possible:</p>
<div class="highlight-python"><pre>class Project_Twig_Extension extends Twig_Extension
{
    public function getName()
    {
        return 'project';
    }
}</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Of course, this extension does nothing for now. We will customize it in
the next sections.</p>
</div>
<p>Twig does not care where you save your extension on the filesystem, as all
extensions must be registered explicitly to be available in your templates.</p>
<p>You can register an extension by using the <tt class="docutils literal"><span class="pre">addExtension()</span></tt> method on your
main <tt class="docutils literal"><span class="pre">Environment</span></tt> object:</p>
<div class="highlight-python"><pre>$twig = new Twig_Environment($loader);
$twig-&gt;addExtension(new Project_Twig_Extension());</pre>
</div>
<p>Of course, you need to first load the extension file by either using
<tt class="docutils literal"><span class="pre">require_once()</span></tt> or by using an autoloader (see <a class="reference external" href="http://www.php.net/spl_autoload_register">spl_autoload_register()</a>).</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">The bundled extensions are great examples of how extensions work.</p>
</div>
<div class="section" id="id1">
<h3>Globals<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Global variables can be registered in an extension via the <tt class="docutils literal"><span class="pre">getGlobals()</span></tt>
method:</p>
<div class="highlight-python"><pre>class Project_Twig_Extension extends Twig_Extension
{
    public function getGlobals()
    {
        return array(
            'text' =&gt; new Text(),
        );
    }

    // ...
}</pre>
</div>
</div>
<div class="section" id="id2">
<h3>Functions<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Functions can be registered in an extension via the <tt class="docutils literal"><span class="pre">getFunctions()</span></tt>
method:</p>
<div class="highlight-python"><pre>class Project_Twig_Extension extends Twig_Extension
{
    public function getFunctions()
    {
        return array(
            new Twig_SimpleFunction('lipsum', 'generate_lipsum'),
        );
    }

    // ...
}</pre>
</div>
</div>
<div class="section" id="id3">
<h3>Filters<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>To add a filter to an extension, you need to override the <tt class="docutils literal"><span class="pre">getFilters()</span></tt>
method. This method must return an array of filters to add to the Twig
environment:</p>
<div class="highlight-python"><pre>class Project_Twig_Extension extends Twig_Extension
{
    public function getFilters()
    {
        return array(
            new Twig_SimpleFilter('rot13', 'str_rot13'),
        );
    }

    // ...
}</pre>
</div>
</div>
<div class="section" id="id4">
<h3>Tags<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Adding a tag in an extension can be done by overriding the
<tt class="docutils literal"><span class="pre">getTokenParsers()</span></tt> method. This method must return an array of tags to add
to the Twig environment:</p>
<div class="highlight-python"><pre>class Project_Twig_Extension extends Twig_Extension
{
    public function getTokenParsers()
    {
        return array(new Project_Set_TokenParser());
    }

    // ...
}</pre>
</div>
<p>In the above code, we have added a single new tag, defined by the
<tt class="docutils literal"><span class="pre">Project_Set_TokenParser</span></tt> class. The <tt class="docutils literal"><span class="pre">Project_Set_TokenParser</span></tt> class is
responsible for parsing the tag and compiling it to PHP.</p>
</div>
<div class="section" id="operators">
<h3>Operators<a class="headerlink" href="#operators" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">getOperators()</span></tt> methods allows to add new operators. Here is how to add
<tt class="docutils literal"><span class="pre">!</span></tt>, <tt class="docutils literal"><span class="pre">||</span></tt>, and <tt class="docutils literal"><span class="pre">&amp;&amp;</span></tt> operators:</p>
<div class="highlight-python"><pre>class Project_Twig_Extension extends Twig_Extension
{
    public function getOperators()
    {
        return array(
            array(
                '!' =&gt; array('precedence' =&gt; 50, 'class' =&gt; 'Twig_Node_Expression_Unary_Not'),
            ),
            array(
                '||' =&gt; array('precedence' =&gt; 10, 'class' =&gt; 'Twig_Node_Expression_Binary_Or', 'associativity' =&gt; Twig_ExpressionParser::OPERATOR_LEFT),
                '&amp;&amp;' =&gt; array('precedence' =&gt; 15, 'class' =&gt; 'Twig_Node_Expression_Binary_And', 'associativity' =&gt; Twig_ExpressionParser::OPERATOR_LEFT),
            ),
        );
    }

    // ...
}</pre>
</div>
</div>
<div class="section" id="id5">
<h3>Tests<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">getTests()</span></tt> methods allows to add new test functions:</p>
<div class="highlight-python"><pre>class Project_Twig_Extension extends Twig_Extension
{
    public function getTests()
    {
        return array(
            new Twig_SimpleTest('even', 'twig_test_even'),
        );
    }

    // ...
}</pre>
</div>
</div>
</div>
<div class="section" id="overloading">
<h2>Overloading<a class="headerlink" href="#overloading" title="Permalink to this headline">¶</a></h2>
<p>To overload an already defined filter, test, operator, global variable, or
function, define it again <strong>as late as possible</strong>:</p>
<div class="highlight-python"><pre>$twig = new Twig_Environment($loader);
$twig-&gt;addFilter(new Twig_SimpleFilter('date', function ($timestamp, $format = 'F j, Y H:i') {
    // do something different from the built-in date filter
}));</pre>
</div>
<p>Here, we have overloaded the built-in <tt class="docutils literal"><span class="pre">date</span></tt> filter with a custom one.</p>
<p>That also works with an extension:</p>
<div class="highlight-python"><pre>class MyCoreExtension extends Twig_Extension
{
    public function getFilters()
    {
        return array(
            new Twig_SimpleFilter('date', array($this, 'dateFilter')),
        );
    }

    public function dateFilter($timestamp, $format = 'F j, Y H:i')
    {
        // do something different from the built-in date filter
    }

    public function getName()
    {
        return 'project';
    }
}

$twig = new Twig_Environment($loader);
$twig-&gt;addExtension(new MyCoreExtension());</pre>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Note that overloading the built-in Twig elements is not recommended as it
might be confusing.</p>
</div>
</div>
<div class="section" id="testing-an-extension">
<h2>Testing an Extension<a class="headerlink" href="#testing-an-extension" title="Permalink to this headline">¶</a></h2>
<div class="section" id="functional-tests">
<h3>Functional Tests<a class="headerlink" href="#functional-tests" title="Permalink to this headline">¶</a></h3>
<p>You can create functional tests for extensions simply by creating the
following file structure in your test directory:</p>
<div class="highlight-python"><pre>Fixtures/
    filters/
        foo.test
        bar.test
    functions/
        foo.test
        bar.test
    tags/
        foo.test
        bar.test
IntegrationTest.php</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">IntegrationTest.php</span></tt> file should look like this:</p>
<div class="highlight-python"><pre>class Project_Tests_IntegrationTest extends Twig_Test_IntegrationTestCase
{
    public function getExtensions()
    {
        return array(
            new Project_Twig_Extension1(),
            new Project_Twig_Extension2(),
        );
    }

    public function getFixturesDir()
    {
        return dirname(__FILE__).'/Fixtures/';
    }
}</pre>
</div>
<p>Fixtures examples can be found within the Twig repository
<a class="reference external" href="https://github.com/fabpot/Twig/tree/master/test/Twig/Tests/Fixtures">tests/Twig/Fixtures</a> directory.</p>
</div>
<div class="section" id="node-tests">
<h3>Node Tests<a class="headerlink" href="#node-tests" title="Permalink to this headline">¶</a></h3>
<p>Testing the node visitors can be complex, so extend your test cases from
<tt class="docutils literal"><span class="pre">Twig_Test_NodeTestCase</span></tt>. Examples can be found in the Twig repository
<a class="reference external" href="https://github.com/fabpot/Twig/tree/master/test/Twig/Tests/Node">tests/Twig/Node</a> directory.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Extending Twig</a><ul>
<li><a class="reference internal" href="#globals">Globals</a></li>
<li><a class="reference internal" href="#filters">Filters</a><ul>
<li><a class="reference internal" href="#environment-aware-filters">Environment aware Filters</a></li>
<li><a class="reference internal" href="#context-aware-filters">Context aware Filters</a></li>
<li><a class="reference internal" href="#automatic-escaping">Automatic Escaping</a></li>
<li><a class="reference internal" href="#dynamic-filters">Dynamic Filters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#functions">Functions</a></li>
<li><a class="reference internal" href="#tests">Tests</a></li>
<li><a class="reference internal" href="#tags">Tags</a><ul>
<li><a class="reference internal" href="#registering-a-new-tag">Registering a new tag</a></li>
<li><a class="reference internal" href="#defining-a-token-parser">Defining a Token Parser</a></li>
<li><a class="reference internal" href="#defining-a-node">Defining a Node</a></li>
</ul>
</li>
<li><a class="reference internal" href="#creating-an-extension">Creating an Extension</a><ul>
<li><a class="reference internal" href="#id1">Globals</a></li>
<li><a class="reference internal" href="#id2">Functions</a></li>
<li><a class="reference internal" href="#id3">Filters</a></li>
<li><a class="reference internal" href="#id4">Tags</a></li>
<li><a class="reference internal" href="#operators">Operators</a></li>
<li><a class="reference internal" href="#id5">Tests</a></li>
</ul>
</li>
<li><a class="reference internal" href="#overloading">Overloading</a></li>
<li><a class="reference internal" href="#testing-an-extension">Testing an Extension</a><ul>
<li><a class="reference internal" href="#functional-tests">Functional Tests</a></li>
<li><a class="reference internal" href="#node-tests">Node Tests</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="api.html"
                        title="previous chapter">Twig for Developers</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="internals.html"
                        title="next chapter">Twig Internals</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/advanced.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="internals.html" title="Twig Internals"
             >next</a> |</li>
        <li class="right" >
          <a href="api.html" title="Twig for Developers"
             >previous</a> |</li>
        <li><a href="index.html">Twig Documentation 1.13.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Fabpot.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>