

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Hacking Twig &mdash; Twig v1 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Twig v1 documentation" href="index.html" />
    <link rel="next" title="Recipes" href="recipes.html" />
    <link rel="prev" title="Creating a Twig Extension" href="extensions.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="recipes.html" title="Recipes"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="extensions.html" title="Creating a Twig Extension"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Twig v1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="hacking-twig">
<h1>Hacking Twig<a class="headerlink" href="#hacking-twig" title="Permalink to this headline">¶</a></h1>
<p>Twig is very extensible and you can easily hack it. Keep in mind that you
should probably try to create an extension before hacking the core, as most
features and enhancements can be done with extensions. This chapter is also
useful for people who want to understand how Twig works under the hood.</p>
<div class="section" id="how-twig-works">
<h2>How Twig works?<a class="headerlink" href="#how-twig-works" title="Permalink to this headline">¶</a></h2>
<p>The rendering of a Twig template can be summarized into four key steps:</p>
<ul class="simple">
<li><strong>Load</strong> the template: If the template is already compiled, load it and go
to the <em>evaluation</em> step, otherwise:<ul>
<li>First, the <strong>lexer</strong> tokenizes the template source code into small pieces
for easier processing;</li>
<li>Then, the <strong>parser</strong> converts the token stream into a meaningful tree
of nodes (the Abstract Syntax Tree);</li>
<li>Eventually, the <em>compiler</em> transforms the AST into PHP code;</li>
</ul>
</li>
<li><strong>Evaluate</strong> the template: It basically means calling the <tt class="docutils literal"><span class="pre">display()</span></tt>
method of the compiled template and passing it the context.</li>
</ul>
</div>
<div class="section" id="the-lexer">
<h2>The Lexer<a class="headerlink" href="#the-lexer" title="Permalink to this headline">¶</a></h2>
<p>The Twig lexer goal is to tokenize a source code into a token stream (each
token is of class <tt class="docutils literal"><span class="pre">Token</span></tt>, and the stream is an instance of
<tt class="docutils literal"><span class="pre">Twig_TokenStream</span></tt>). The default lexer recognizes nine different token types:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">Twig_Token::TEXT_TYPE</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Twig_Token::BLOCK_START_TYPE</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Twig_Token::VAR_START_TYPE</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Twig_Token::BLOCK_END_TYPE</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Twig_Token::VAR_END_TYPE</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Twig_Token::NAME_TYPE</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Twig_Token::NUMBER_TYPE</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Twig_Token::STRING_TYPE</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Twig_Token::OPERATOR_TYPE</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Twig_Token::EOF_TYPE</span></tt></li>
</ul>
<p>You can manually convert a source code into a token stream by calling the
<tt class="docutils literal"><span class="pre">tokenize()</span></tt> of an environment:</p>
<div class="highlight-python"><pre>$stream = $twig-&gt;tokenize($source, $identifier);</pre>
</div>
<p>As the stream has a <tt class="docutils literal"><span class="pre">__toString()</span></tt> method, you can have a textual
representation of it by echoing the object:</p>
<div class="highlight-python"><pre>echo $stream."\n";</pre>
</div>
<p>Here is the output for the <tt class="docutils literal"><span class="pre">Hello</span> <span class="pre">{{</span> <span class="pre">name</span> <span class="pre">}}</span></tt> template:</p>
<div class="highlight-text"><div class="highlight"><pre>TEXT_TYPE(Hello )
VAR_START_TYPE()
NAME_TYPE(name)
VAR_END_TYPE()
EOF_TYPE()
</pre></div>
</div>
<p>You can change the default lexer use by Twig (<tt class="docutils literal"><span class="pre">Twig_Lexer</span></tt>) by calling the
<tt class="docutils literal"><span class="pre">setLexer()</span></tt> method:</p>
<div class="highlight-python"><pre>$twig-&gt;setLexer($lexer);</pre>
</div>
<p>Lexer classes must implement the <tt class="docutils literal"><span class="pre">Twig_LexerInterface</span></tt>:</p>
<div class="highlight-python"><pre>interface Twig_LexerInterface
{
    /**
     * Tokenizes a source code.
     *
     * @param  string $code     The source code
     * @param  string $filename A unique identifier for the source code
     *
     * @return Twig_TokenStream A token stream instance
     */
    function tokenize($code, $filename = 'n/a');
}</pre>
</div>
</div>
<div class="section" id="the-parser">
<h2>The Parser<a class="headerlink" href="#the-parser" title="Permalink to this headline">¶</a></h2>
<p>The parser converts the token stream into an AST (Abstract Syntax Tree), or a
node tree (of class <tt class="docutils literal"><span class="pre">Twig_Node_Module</span></tt>). The core extension defines the
basic nodes like: <tt class="docutils literal"><span class="pre">for</span></tt>, <tt class="docutils literal"><span class="pre">if</span></tt>, ... and the expression nodes.</p>
<p>You can manually convert a token stream into a node tree by calling the
<tt class="docutils literal"><span class="pre">parse()</span></tt> method of an environment:</p>
<div class="highlight-python"><pre>$nodes = $twig-&gt;parse($stream);</pre>
</div>
<p>Echoing the node object gives you a nice representation of the tree:</p>
<div class="highlight-python"><pre>echo $nodes."\n";</pre>
</div>
<p>Here is the output for the <tt class="docutils literal"><span class="pre">Hello</span> <span class="pre">{{</span> <span class="pre">name</span> <span class="pre">}}</span></tt> template:</p>
<div class="highlight-text"><div class="highlight"><pre>Twig_Node_Module(
  Twig_Node_Text(Hello )
  Twig_Node_Print(
    Twig_Node_Expression_Name(name)
  )
)
</pre></div>
</div>
<p>The default parser (<tt class="docutils literal"><span class="pre">Twig_TokenParser</span></tt>) can be also changed by calling the
<tt class="docutils literal"><span class="pre">setParser()</span></tt> method:</p>
<div class="highlight-python"><pre>$twig-&gt;setParser($parser);</pre>
</div>
<p>All Twig parsers must implement the <tt class="docutils literal"><span class="pre">Twig_ParserInterface</span></tt>:</p>
<div class="highlight-python"><pre>interface Twig_ParserInterface
{
    /**
     * Converts a token stream to a node tree.
     *
     * @param  Twig_TokenStream $stream A token stream instance
     *
     * @return Twig_Node_Module A node tree
     */
    function parser(Twig_TokenStream $code);
}</pre>
</div>
</div>
<div class="section" id="the-compiler">
<h2>The Compiler<a class="headerlink" href="#the-compiler" title="Permalink to this headline">¶</a></h2>
<p>The last step is done by the compiler. It takes a node tree as an input and
generates PHP code usable for runtime execution of the templates. The default
compiler generates PHP classes to ease the implementation of the template
inheritance feature.</p>
<p>You can call the compiler by hand with the <tt class="docutils literal"><span class="pre">compile()</span></tt> method of an
environment:</p>
<div class="highlight-python"><pre>$php = $twig-&gt;compile($nodes);</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">compile()</span></tt> method returns the PHP source code representing the node.</p>
<p>The generated template for a <tt class="docutils literal"><span class="pre">Hello</span> <span class="pre">{{</span> <span class="pre">name</span> <span class="pre">}}</span></tt> template reads as follows:</p>
<div class="highlight-python"><pre>/* Hello {{ name }} */
class __TwigTemplate_1121b6f109fe93ebe8c6e22e3712bceb extends Twig_Template
{
    public function display($context)
    {
        $this-&gt;env-&gt;initRuntime();

        // line 1
        echo "Hello ";
        echo (isset($context['name']) ? $context['name'] : null);
    }
}</pre>
</div>
<p>As for the lexer and the parser, the default compiler (<tt class="docutils literal"><span class="pre">Twig_Compiler</span></tt>) can
be changed by calling the <tt class="docutils literal"><span class="pre">setCompiler()</span></tt> method:</p>
<div class="highlight-python"><pre>$twig-&gt;setCompiler($compiler);</pre>
</div>
<p>All Twig compilers must implement the <tt class="docutils literal"><span class="pre">Twig_CompilerInterface</span></tt>:</p>
<div class="highlight-python"><pre>interface Twig_CompilerInterface
{
    /**
     * Compiles a node.
     *
     * @param  Twig_Node $node The node to compile
     *
     * @return Twig_Compiler The current compiler instance
     */
    function compile(Twig_Node $node);

    /**
     * Gets the current PHP code after compilation.
     *
     * @return string The PHP code
     */
    function getSource();
}</pre>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Hacking Twig</a><ul>
<li><a class="reference internal" href="#how-twig-works">How Twig works?</a></li>
<li><a class="reference internal" href="#the-lexer">The Lexer</a></li>
<li><a class="reference internal" href="#the-parser">The Parser</a></li>
<li><a class="reference internal" href="#the-compiler">The Compiler</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="extensions.html"
                        title="previous chapter">Creating a Twig Extension</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="recipes.html"
                        title="next chapter">Recipes</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/hacking.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="recipes.html" title="Recipes"
             >next</a> |</li>
        <li class="right" >
          <a href="extensions.html" title="Creating a Twig Extension"
             >previous</a> |</li>
        <li><a href="index.html">Twig v1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Rafael Goulart.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>